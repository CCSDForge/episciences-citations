# HTTP VirtualHost - Redirect to HTTPS
<VirtualHost *:80>
    ServerAdmin contact@example.org
    ServerName citations-dev.episciences.org

    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://citations-dev.episciences.org/

    ErrorLog /usr/local/apache2/logs/citations-error.log
    CustomLog /usr/local/apache2/logs/citations-access.log combined
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost *:443>
    ServerAdmin contact@example.org
    DocumentRoot /var/www/htdocs/public/
    SetEnv APPLICATION_ENV development

    ServerName citations-dev.episciences.org
    Alias /public /var/www/htdocs/public

    DirectoryIndex index.php

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /usr/local/apache2/conf/ssl/server.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/ssl/server.key

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Pass PHP scripts to the PHP-FPM container via TCP
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://epi-citations-php-fpm:9000"
    </FilesMatch>

    # Increase timeout for PHP-FPM proxy
    ProxyTimeout 300

    <Directory "/var/www/htdocs/">
        Options Indexes MultiViews FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog /usr/local/apache2/logs/citations-error.log
    CustomLog /usr/local/apache2/logs/citations-access.log combined
</VirtualHost>

